<!DOCTYPE html>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë   Blockchain Rice Supply Chain Management System          ‚ïë
  ‚ïë   Author: NNB (Nguyen Ngoc Binh)                         ‚ïë
  ‚ïë   Copyright ¬© 2025 NNB. All Rights Reserved.             ‚ïë
  ‚ïë   GitHub: https://github.com/ngocbinh15                   ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠p li·ªáu - Chu·ªói cung ·ª©ng</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2328a745;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2320c997;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-family='Arial, sans-serif' font-size='45' font-weight='bold' fill='white' text-anchor='middle'%3ENNB%3C/text%3E%3C/svg%3E">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .page-header {
      animation: fadeInUp 0.6s ease-out;
    }

    .tab-card {
      animation: fadeInUp 0.8s ease-out;
    }
  </style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-gradient">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bi bi-box-seam"></i> Rice Chain - Nh·∫≠p li·ªáu
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <span class="nav-link text-white">
              <i class="bi bi-person-circle"></i> <span id="userDisplayName">Ng∆∞·ªùi d√πng</span>
            </span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()">
              <i class="bi bi-box-arrow-left"></i> ƒêƒÉng xu·∫•t
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="container py-4">
    <!-- Header -->
    <div class="row mb-4 page-header">
      <div class="col text-center">
        <i class="bi bi-clipboard-data text-success header-icon" style="font-size: 3rem;"></i>
        <h2 class="mt-2 fw-bold"><i class="bi bi-clipboard-data"></i> Qu·∫£n l√Ω Chu·ªói Cung ·ª®ng</h2>
        <p class="text-muted">Ghi nh·∫≠n c√°c s·ª± ki·ªán trong qu√° tr√¨nh s·∫£n xu·∫•t v√† v·∫≠n chuy·ªÉn</p>
      </div>
    </div>

    <!-- ===== TAB NAVIGATION ===== -->
    <ul class="nav nav-tabs nav-fill mb-4 tab-card" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold" id="create-tab" data-bs-toggle="tab" data-bs-target="#create"
          type="button" style="color: #28a745;">
          <i class="bi bi-plus-circle"></i> T·∫°o L√¥ M·ªõi (UC2)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button"
          style="color: #28a745;">
          <i class="bi bi-calendar-check"></i> Ghi Nh·∫≠n S·ª± Ki·ªán (UC3)
        </button>
      </li>
    </ul>

    <!-- ===== TAB CONTENT ===== -->
    <div class="tab-content" id="myTabContent">

      <!-- ===== TAB 1: T·∫†O L√î S·∫¢N PH·∫®M M·ªöI (UC2) ===== -->
      <div class="tab-pane fade show active" id="create" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="modern-card">
              <div class="card-header text-white"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; border-radius: 20px 20px 0 0;">
                <h5 class="mb-0 fw-bold"><i class="bi bi-plus-square"></i> Kh·ªüi t·∫°o l√¥ s·∫£n ph·∫©m m·ªõi</h5>
              </div>
              <div class="card-body p-4">
                <form id="createBatchForm">
                  <!-- Gi·ªëng l√∫a -->
                  <div class="mb-3">
                    <label for="riceVariety" class="form-label">
                      <i class="bi bi-flower1"></i> Gi·ªëng l√∫a <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="riceVariety" required>
                      <option value="" selected disabled>-- Ch·ªçn gi·ªëng l√∫a --</option>
                      <option value="N√†ng hoa 9">N√†ng hoa 9</option>
                      <option value="Jasmine 85">Jasmine 85</option>
                      <option value="ST25">ST25 (G·∫°o ngon nh·∫•t th·∫ø gi·ªõi)</option>
                      <option value="OM18">OM18</option>
                      <option value="N·∫øp c√°i hoa v√†ng">N·∫øp c√°i hoa v√†ng</option>
                      <option value="IR50404">IR50404</option>
                      <option value="Kh√°c">Kh√°c</option>
                    </select>
                  </div>

                  <!-- Khu v·ª±c tr·ªìng -->
                  <div class="mb-3">
                    <label for="location" class="form-label">
                      <i class="bi bi-geo-alt"></i> Khu v·ª±c tr·ªìng <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="location"
                      placeholder="VD: X√£ T√¢n Ph√∫, Huy·ªán Vƒ©nh C·ª≠u, T·ªânh ƒê·ªìng Nai" required>
                  </div>

                  <!-- Di·ªán t√≠ch -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="area" class="form-label">
                        <i class="bi bi-bounding-box"></i> Di·ªán t√≠ch (ha) <span class="text-danger">*</span>
                      </label>
                      <input type="number" class="form-control" id="area" placeholder="VD: 2.5" step="0.1" min="0.1"
                        required>
                    </div>

                    <!-- Ng√†y gieo tr·ªìng -->
                    <div class="col-md-6 mb-3">
                      <label for="plantDate" class="form-label">
                        <i class="bi bi-calendar"></i> Ng√†y gieo tr·ªìng <span class="text-danger">*</span>
                      </label>
                      <input type="date" class="form-control" id="plantDate" required>
                    </div>
                  </div>

                  <!-- Ghi ch√∫ -->
                  <div class="mb-3">
                    <label for="batchNote" class="form-label">
                      <i class="bi bi-sticky"></i> Ghi ch√∫
                    </label>
                    <textarea class="form-control" id="batchNote" rows="3"
                      placeholder="Th√¥ng tin b·ªï sung v·ªÅ l√¥ s·∫£n ph·∫©m..."></textarea>
                  </div>

                  <!-- Token ID display (s·∫Ω ƒë∆∞·ª£c sinh t·ª± ƒë·ªông) -->
                  <div class="mb-3" id="tokenIdDisplay" style="display:none;">
                    <div class="alert alert-success">
                      <h6><i class="bi bi-key"></i> Token ID ƒë√£ ƒë∆∞·ª£c t·∫°o:</h6>
                      <code id="generatedTokenId" class="fs-6"></code>
                      <button type="button" class="btn btn-sm btn-outline-success float-end" onclick="copyTokenId()">
                        <i class="bi bi-clipboard"></i> Sao ch√©p
                      </button>
                    </div>
                  </div>

                  <!-- N√∫t submit -->
                  <div class="d-grid gap-2">
                    <button type="submit" class="modern-btn btn-lg">
                      <i class="bi bi-save"></i> Ghi nh·∫≠n s·ª± ki·ªán
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB 2: GHI NH·∫¨N S·ª∞ KI·ªÜN (UC3) ===== -->
      <div class="tab-pane fade" id="event" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="modern-card">
              <div class="card-header text-white"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; border-radius: 20px 20px 0 0;">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calendar-event"></i> Ghi nh·∫≠n s·ª± ki·ªán chu·ªói cung ·ª©ng</h5>
              </div>
              <div class="card-body p-4">
                <form id="eventForm">
                  <!-- Ch·ªçn Token ID -->
                  <div class="mb-3">
                    <label for="tokenId" class="form-label">
                      <i class="bi bi-key"></i> Token ID / M√£ l√¥ <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="tokenId" required>
                      <option value="" selected disabled>-- Ch·ªçn l√¥ s·∫£n ph·∫©m --</option>
                      <!-- S·∫Ω ƒë∆∞·ª£c load t·ª´ localStorage ho·∫∑c d·ªØ li·ªáu m·∫´u -->
                    </select>
                    <small class="text-muted">Ho·∫∑c nh·∫≠p m√£ l√¥ th·ªß c√¥ng n·∫øu kh√¥ng t√¨m th·∫•y</small>
                  </div>

                  <!-- Lo·∫°i s·ª± ki·ªán -->
                  <div class="mb-3">
                    <label for="eventType" class="form-label">
                      <i class="bi bi-tags"></i> Lo·∫°i s·ª± ki·ªán <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="eventType" required>
                      <option value="" selected disabled>-- Ch·ªçn lo·∫°i s·ª± ki·ªán --</option>
                      <option value="fertilizing">üå± B√≥n ph√¢n</option>
                      <option value="irrigation">üíß T∆∞·ªõi ti√™u</option>
                      <option value="harvesting">üåæ Thu ho·∫°ch</option>
                      <option value="milling">üè≠ Xay x√°t</option>
                      <option value="packaging">üì¶ ƒê√≥ng g√≥i</option>
                      <option value="shipping">üöö V·∫≠n chuy·ªÉn</option>
                      <option value="warehouse_in">üì• Nh·∫≠p kho</option>
                      <option value="warehouse_out">üì§ Xu·∫•t kho</option>
                      <option value="quality_check">‚úÖ Ki·ªÉm tra ch·∫•t l∆∞·ª£ng</option>
                      <option value="distribution">üè™ Ph√¢n ph·ªëi</option>
                    </select>
                  </div>

                  <!-- Th·ªùi gian s·ª± ki·ªán -->
                  <div class="mb-3">
                    <label for="eventTime" class="form-label">
                      <i class="bi bi-clock"></i> Th·ªùi gian th·ª±c hi·ªán <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" id="eventTime" required>
                  </div>

                  <!-- ƒê·ªãa ƒëi·ªÉm -->
                  <div class="mb-3">
                    <label for="eventLocation" class="form-label">
                      <i class="bi bi-geo"></i> ƒê·ªãa ƒëi·ªÉm
                    </label>
                    <input type="text" class="form-control" id="eventLocation"
                      placeholder="VD: Nh√† m√°y xay x√°t ABC, ƒê·ªìng Nai">
                  </div>

                  <!-- Ng∆∞·ªùi th·ª±c hi·ªán -->
                  <div class="mb-3">
                    <label for="eventPerformer" class="form-label">
                      <i class="bi bi-person"></i> Ng∆∞·ªùi th·ª±c hi·ªán
                    </label>
                    <input type="text" class="form-control" id="eventPerformer"
                      placeholder="T√™n ng∆∞·ªùi/ƒë∆°n v·ªã th·ª±c hi·ªán">
                  </div>

                  <!-- M√¥ t·∫£ chi ti·∫øt -->
                  <div class="mb-3">
                    <label for="eventDescription" class="form-label">
                      <i class="bi bi-card-text"></i> M√¥ t·∫£ chi ti·∫øt <span class="text-danger">*</span>
                    </label>
                    <textarea class="form-control" id="eventDescription" rows="4"
                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán n√†y..." required></textarea>
                  </div>

                  <!-- N√∫t submit -->
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                      <i class="bi bi-send"></i> Ghi nh·∫≠n s·ª± ki·ªán
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- L·ªãch s·ª≠ s·ª± ki·ªán ƒë√£ ghi nh·∫≠n -->
            <div class="card shadow mt-4">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> S·ª± ki·ªán ƒë√£ ghi nh·∫≠n g·∫ßn ƒë√¢y</h6>
              </div>
              <div class="card-body">
                <div id="recentEvents" class="list-group">
                  <!-- Danh s√°ch s·ª± ki·ªán s·∫Ω ƒë∆∞·ª£c th√™m b·ªüi JS -->
                  <div class="text-center text-muted py-3">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mb-0 mt-2">Ch∆∞a c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast" role="alert">
      <div class="toast-header bg-success text-white">
        <i class="bi bi-check-circle me-2"></i>
        <strong class="me-auto">Th√†nh c√¥ng</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastMessage">
        S·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n l√™n blockchain (m√¥ ph·ªèng)
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    // ===== API CONFIG =====
    const API_BASE_URL = 'https://web-blockchain-production.up.railway.app/api';

    // ===== CHECK LOGIN =====
    window.addEventListener('DOMContentLoaded', () => {
      const userRole = localStorage.getItem('userRole');
      const username = localStorage.getItem('username');
      const token = localStorage.getItem('token');

      if (!userRole || !token) {
        alert('‚ö†Ô∏è B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y!');
        window.location.href = 'login.html';
        return;
      }

      // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
      if (username) {
        document.getElementById('userDisplayName').textContent = username;
      }

      // Set ng√†y hi·ªán t·∫°i cho c√°c input date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('plantDate').value = today;

      const now = new Date().toISOString().slice(0, 16);
      document.getElementById('eventTime').value = now;

      // Load token IDs c√≥ s·∫µn
      loadTokenIds();

      // Load recent events
      loadRecentEvents();
    });

    // ===== LOGOUT =====
    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
      }
    }

    // ===== UC2: T·∫†O L√î S·∫¢N PH·∫®M M·ªöI =====
    document.getElementById('createBatchForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const variety = document.getElementById('riceVariety').value;
      const location = document.getElementById('location').value;
      const area = document.getElementById('area').value;
      const plantDate = document.getElementById('plantDate').value;
      const note = document.getElementById('batchNote').value;

      // Sinh Token ID (hash m√¥ ph·ªèng)
      const tokenId = generateTokenId(variety, location, plantDate);

      try {
        // G·ªçi API ƒë·ªÉ t·∫°o batch m·ªõi
        const response = await fetch(`${API_BASE_URL}/batches`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            code: tokenId,
            variety: variety,
            location: location,
            area: parseFloat(area),
            plantDate: plantDate,
            notes: note
          })
        });

        const result = await response.json();

        if (result.success) {
          // Hi·ªÉn th·ªã Token ID
          document.getElementById('generatedTokenId').textContent = tokenId;
          document.getElementById('tokenIdDisplay').style.display = 'block';

          // Hi·ªÉn th·ªã th√¥ng b√°o
          showToast(`‚úÖ L√¥ s·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\n\nToken ID: ${tokenId}\n\nüîó Giao d·ªãch ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n tr√™n blockchain.`);

          // Reset form sau 3s
          setTimeout(() => {
            this.reset();
            document.getElementById('tokenIdDisplay').style.display = 'none';
            loadTokenIds(); // Reload danh s√°ch
          }, 3000);
        } else {
          throw new Error(result.message || 'API failed');
        }
      } catch (error) {
        console.error('Create batch error:', error);

        // Hi·ªÉn th·ªã l·ªói chi ti·∫øt - KH√îNG fallback localStorage
        let errorMsg = '‚ùå Kh√¥ng th·ªÉ t·∫°o l√¥ s·∫£n ph·∫©m!\n\n';
        if (error.message && error.message.includes('fetch')) {
          errorMsg += 'üîå L·ªói k·∫øt n·ªëi server.\n\n';
        } else if (!token) {
          errorMsg += 'üîë B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.\n\n';
        } else {
          errorMsg += `üìù ${error.message}\n\n`;
        }
        errorMsg += 'Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá admin.';

        showToast(errorMsg);
      }
    });    // ===== SINH TOKEN ID M√î PH·ªéNG =====
    function generateTokenId(variety, location, date) {
      const timestamp = new Date().getTime();
      const random = Math.random().toString(36).substring(2, 8).toUpperCase();
      const hash = simpleHash(variety + location + date + timestamp);
      return `BC${hash}${random}`;
    }

    // Hash ƒë∆°n gi·∫£n (m√¥ ph·ªèng)
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16).substring(0, 6).toUpperCase();
    }

    // ===== COPY TOKEN ID =====
    function copyTokenId() {
      const tokenId = document.getElementById('generatedTokenId').textContent;
      navigator.clipboard.writeText(tokenId).then(() => {
        alert('‚úÖ ƒê√£ sao ch√©p Token ID v√†o clipboard!');
      });
    }

    document.getElementById('eventForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const tokenId = document.getElementById('tokenId').value;
      const eventType = document.getElementById('eventType').value;
      const eventTime = document.getElementById('eventTime').value;
      const eventLocation = document.getElementById('eventLocation').value;
      const eventPerformer = document.getElementById('eventPerformer').value;
      const eventDescription = document.getElementById('eventDescription').value;

      try {
        // G·ªçi API ƒë·ªÉ th√™m transaction/event
        const response = await fetch(`${API_BASE_URL}/batches/${tokenId}/transaction`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            type: eventType,
            location: eventLocation,
            performer: eventPerformer || username || 'Unknown',
            description: eventDescription,
            timestamp: eventTime
          })
        });

        const result = await response.json();

        if (result.success) {
          // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
          showToast(`‚úÖ S·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n!\n\nüì¶ L√¥: ${tokenId}\nüìù ${document.getElementById('eventType').selectedOptions[0].text}\n\nüîó ƒê√£ l∆∞u tr√™n blockchain.`);

          // Reset form sau 2s
          setTimeout(() => {
            this.reset();
            loadRecentEvents(); // Reload danh s√°ch s·ª± ki·ªán
          }, 2000);
        } else {
          throw new Error(result.message || 'API failed');
        }
      } catch (error) {
        console.error('Add event error:', error);

        // Hi·ªÉn th·ªã l·ªói chi ti·∫øt - KH√îNG fallback localStorage
        let errorMsg = '‚ùå Kh√¥ng th·ªÉ ghi nh·∫≠n s·ª± ki·ªán!\n\n';
        if (error.message && error.message.includes('fetch')) {
          errorMsg += 'üîå L·ªói k·∫øt n·ªëi server.\n\n';
        } else if (!token) {
          errorMsg += 'üîë B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.\n\n';
        } else {
          errorMsg += `üìù ${error.message}\n\n`;
        }
        errorMsg += 'Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá admin.';

        showToast(errorMsg);
      }
    });    // ===== LOAD TOKEN IDs =====
    function loadTokenIds() {
      const batches = JSON.parse(localStorage.getItem('riceBatches') || '[]');
      const select = document.getElementById('tokenId');

      // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
      while (select.options.length > 1) {
        select.remove(1);
      }

      // Th√™m c√°c token ID
      batches.forEach(batch => {
        const option = document.createElement('option');
        option.value = batch.tokenId;
        option.textContent = `${batch.tokenId} - ${batch.variety}`;
        select.appendChild(option);
      });

      // Th√™m option m·∫´u n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
      if (batches.length === 0) {
        ['BC001ABC', 'BC002XYZ', 'BC003DEF'].forEach(id => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = id + ' (M·∫´u)';
          select.appendChild(option);
        });
      }
    }

    // ===== LOAD RECENT EVENTS =====
    function loadRecentEvents() {
      const events = JSON.parse(localStorage.getItem('riceEvents') || '[]');
      const container = document.getElementById('recentEvents');

      if (events.length === 0) {
        container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                        <p class="mb-0 mt-2">Ch∆∞a c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>
                    </div>
                `;
        return;
      }

      container.innerHTML = '';
      events.slice(0, 5).forEach(event => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${event.typeName}</h6>
                            <p class="mb-1 small">${event.description}</p>
                            <small class="text-muted">
                                <i class="bi bi-key"></i> ${event.tokenId} | 
                                <i class="bi bi-clock"></i> ${new Date(event.time).toLocaleString('vi-VN')} |
                                <i class="bi bi-hash"></i> ${event.blockHash}
                            </small>
                        </div>
                        <span class="badge bg-success">ƒê√£ ghi nh·∫≠n</span>
                    </div>
                `;
        container.appendChild(item);
      });
    }

    // ===== SHOW TOAST =====
    function showToast(message) {
      document.getElementById('toastMessage').textContent = message;
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      toast.show();
    }
  </script>

  <!-- Copyright -->
  <p style="text-align: center; margin: 20px 0; color: rgba(255, 255, 255, 0.6); font-size: 10px;">Copyright ¬© 2025 NNB
  </p>
</body>

</html>