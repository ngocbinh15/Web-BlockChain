<!DOCTYPE html>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë   Blockchain Rice Supply Chain Management System          ‚ïë
  ‚ïë   Author: NNB (Nguyen Ngoc Binh)                         ‚ïë
  ‚ïë   Copyright ¬© 2025 NNB. All Rights Reserved.             ‚ïë
  ‚ïë   GitHub: https://github.com/ngocbinh15                   ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nh·∫≠p li·ªáu - Chu·ªói cung ·ª©ng</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%2328a745;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2320c997;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='70' font-family='Arial, sans-serif' font-size='45' font-weight='bold' fill='white' text-anchor='middle'%3ENNB%3C/text%3E%3C/svg%3E">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .page-header {
      animation: fadeInUp 0.6s ease-out;
    }

    .tab-card {
      animation: fadeInUp 0.8s ease-out;
    }
  </style>
</head>

<body>
  <!-- ===== NAVBAR ===== -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-gradient">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">
        <i class="bi bi-box-seam"></i> Rice Chain - Nh·∫≠p li·ªáu
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <span class="nav-link text-white">
              <i class="bi bi-person-circle"></i> <span id="userDisplayName">Ng∆∞·ªùi d√πng</span>
            </span>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()">
              <i class="bi bi-box-arrow-left"></i> ƒêƒÉng xu·∫•t
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- ===== MAIN CONTENT ===== -->
  <div class="container py-4">
    <!-- Header -->
    <div class="row mb-4 page-header">
      <div class="col text-center">
        <i class="bi bi-clipboard-data text-success header-icon" style="font-size: 3rem;"></i>
        <h2 class="mt-2 fw-bold"><i class="bi bi-clipboard-data"></i> Qu·∫£n l√Ω Chu·ªói Cung ·ª®ng</h2>
        <p class="text-muted">Ghi nh·∫≠n c√°c s·ª± ki·ªán trong qu√° tr√¨nh s·∫£n xu·∫•t v√† v·∫≠n chuy·ªÉn</p>
      </div>
    </div>

    <!-- ===== TAB NAVIGATION ===== -->
    <ul class="nav nav-tabs nav-fill mb-4 tab-card" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active fw-bold" id="create-tab" data-bs-toggle="tab" data-bs-target="#create"
          type="button" style="color: #28a745;">
          <i class="bi bi-plus-circle"></i> T·∫°o L√¥ M·ªõi (UC2)
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link fw-bold" id="event-tab" data-bs-toggle="tab" data-bs-target="#event" type="button"
          style="color: #28a745;">
          <i class="bi bi-calendar-check"></i> Ghi Nh·∫≠n S·ª± Ki·ªán (UC3)
        </button>
      </li>
    </ul>

    <!-- ===== TAB CONTENT ===== -->
    <div class="tab-content" id="myTabContent">

      <!-- ===== TAB 1: T·∫†O L√î S·∫¢N PH·∫®M M·ªöI (UC2) ===== -->
      <div class="tab-pane fade show active" id="create" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="modern-card">
              <div class="card-header text-white"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; border-radius: 20px 20px 0 0;">
                <h5 class="mb-0 fw-bold"><i class="bi bi-plus-square"></i> Kh·ªüi t·∫°o l√¥ s·∫£n ph·∫©m m·ªõi</h5>
              </div>
              <div class="card-body p-4">
                <form id="createBatchForm">
                  <!-- Gi·ªëng l√∫a -->
                  <div class="mb-3">
                    <label for="riceVariety" class="form-label">
                      <i class="bi bi-flower1"></i> Gi·ªëng l√∫a <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="riceVariety" required>
                      <option value="" selected disabled>-- Ch·ªçn gi·ªëng l√∫a --</option>
                      <option value="N√†ng hoa 9">N√†ng hoa 9</option>
                      <option value="Jasmine 85">Jasmine 85</option>
                      <option value="ST25">ST25 (G·∫°o ngon nh·∫•t th·∫ø gi·ªõi)</option>
                      <option value="OM18">OM18</option>
                      <option value="N·∫øp c√°i hoa v√†ng">N·∫øp c√°i hoa v√†ng</option>
                      <option value="IR50404">IR50404</option>
                      <option value="Kh√°c">Kh√°c</option>
                    </select>
                  </div>

                  <!-- Khu v·ª±c tr·ªìng -->
                  <div class="mb-3">
                    <label for="location" class="form-label">
                      <i class="bi bi-geo-alt"></i> Khu v·ª±c tr·ªìng <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control" id="location"
                      placeholder="VD: X√£ T√¢n Ph√∫, Huy·ªán Vƒ©nh C·ª≠u, T·ªânh ƒê·ªìng Nai" required>
                  </div>

                  <!-- Di·ªán t√≠ch -->
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="area" class="form-label">
                        <i class="bi bi-bounding-box"></i> Di·ªán t√≠ch (ha) <span class="text-danger">*</span>
                      </label>
                      <input type="number" class="form-control" id="area" placeholder="VD: 2.5" step="0.1" min="0.1"
                        required>
                    </div>

                    <!-- Ng√†y gieo tr·ªìng -->
                    <div class="col-md-6 mb-3">
                      <label for="plantDate" class="form-label">
                        <i class="bi bi-calendar"></i> Ng√†y gieo tr·ªìng <span class="text-danger">*</span>
                      </label>
                      <input type="date" class="form-control" id="plantDate" required>
                    </div>
                  </div>

                  <!-- Ghi ch√∫ -->
                  <div class="mb-3">
                    <label for="batchNote" class="form-label">
                      <i class="bi bi-sticky"></i> Ghi ch√∫
                    </label>
                    <textarea class="form-control" id="batchNote" rows="3"
                      placeholder="Th√¥ng tin b·ªï sung v·ªÅ l√¥ s·∫£n ph·∫©m..."></textarea>
                  </div>

                  <!-- Token ID display (s·∫Ω ƒë∆∞·ª£c sinh t·ª± ƒë·ªông) -->
                  <div class="mb-3" id="tokenIdDisplay" style="display:none;">
                    <div class="alert alert-success">
                      <h6><i class="bi bi-key"></i> Token ID ƒë√£ ƒë∆∞·ª£c t·∫°o:</h6>
                      <code id="generatedTokenId" class="fs-6"></code>
                      <button type="button" class="btn btn-sm btn-outline-success float-end" onclick="copyTokenId()">
                        <i class="bi bi-clipboard"></i> Sao ch√©p
                      </button>
                    </div>
                  </div>

                  <!-- N√∫t submit -->
                  <div class="d-grid gap-2">
                    <button type="submit" class="modern-btn btn-lg">
                      <i class="bi bi-save"></i> Ghi nh·∫≠n s·ª± ki·ªán
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== TAB 2: GHI NH·∫¨N S·ª∞ KI·ªÜN (UC3) ===== -->
      <div class="tab-pane fade" id="event" role="tabpanel">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="modern-card">
              <div class="card-header text-white"
                style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; border-radius: 20px 20px 0 0;">
                <h5 class="mb-0 fw-bold"><i class="bi bi-calendar-event"></i> Ghi nh·∫≠n s·ª± ki·ªán chu·ªói cung ·ª©ng</h5>
              </div>
              <div class="card-body p-4">
                <form id="eventForm">
                  <!-- Ch·ªçn Token ID -->
                  <div class="mb-3">
                    <label for="tokenId" class="form-label">
                      <i class="bi bi-key"></i> Token ID / M√£ l√¥ <span class="text-danger">*</span>
                    </label>
                    <div class="input-group">
                      <select class="form-select" id="tokenId" required>
                        <option value="" selected disabled>-- Ch·ªçn l√¥ s·∫£n ph·∫©m --</option>
                        <!-- S·∫Ω ƒë∆∞·ª£c load t·ª´ API -->
                      </select>
                      <button class="btn btn-outline-success" type="button" onclick="copySelectedTokenId()"
                        title="Sao ch√©p m√£ l√¥">
                        <i class="bi bi-clipboard"></i>
                      </button>
                    </div>
                    <small class="text-muted">Ch·ªçn m√£ l√¥ ƒë√£ t·∫°o ho·∫∑c nh·∫≠p th·ªß c√¥ng</small>
                  </div>

                  <!-- Lo·∫°i s·ª± ki·ªán -->
                  <div class="mb-3">
                    <label for="eventType" class="form-label">
                      <i class="bi bi-tags"></i> Lo·∫°i s·ª± ki·ªán <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="eventType" required>
                      <option value="" selected disabled>-- Ch·ªçn lo·∫°i s·ª± ki·ªán --</option>
                      <option value="fertilizing">üå± B√≥n ph√¢n</option>
                      <option value="irrigation">üíß T∆∞·ªõi ti√™u</option>
                      <option value="harvesting">üåæ Thu ho·∫°ch</option>
                      <option value="milling">üè≠ Xay x√°t</option>
                      <option value="packaging">üì¶ ƒê√≥ng g√≥i</option>
                      <option value="shipping">üöö V·∫≠n chuy·ªÉn</option>
                      <option value="warehouse_in">üì• Nh·∫≠p kho</option>
                      <option value="warehouse_out">üì§ Xu·∫•t kho</option>
                      <option value="quality_check">‚úÖ Ki·ªÉm tra ch·∫•t l∆∞·ª£ng</option>
                      <option value="distribution">üè™ Ph√¢n ph·ªëi</option>
                    </select>
                  </div>

                  <!-- Th·ªùi gian s·ª± ki·ªán -->
                  <div class="mb-3">
                    <label for="eventTime" class="form-label">
                      <i class="bi bi-clock"></i> Th·ªùi gian th·ª±c hi·ªán <span class="text-danger">*</span>
                    </label>
                    <input type="datetime-local" class="form-control" id="eventTime" required>
                  </div>

                  <!-- ƒê·ªãa ƒëi·ªÉm -->
                  <div class="mb-3">
                    <label for="eventLocation" class="form-label">
                      <i class="bi bi-geo"></i> ƒê·ªãa ƒëi·ªÉm
                    </label>
                    <input type="text" class="form-control" id="eventLocation"
                      placeholder="VD: Nh√† m√°y xay x√°t ABC, ƒê·ªìng Nai">
                  </div>

                  <!-- Ng∆∞·ªùi th·ª±c hi·ªán -->
                  <div class="mb-3">
                    <label for="eventPerformer" class="form-label">
                      <i class="bi bi-person"></i> Ng∆∞·ªùi th·ª±c hi·ªán
                    </label>
                    <input type="text" class="form-control" id="eventPerformer"
                      placeholder="T√™n ng∆∞·ªùi/ƒë∆°n v·ªã th·ª±c hi·ªán">
                  </div>

                  <!-- M√¥ t·∫£ chi ti·∫øt -->
                  <div class="mb-3">
                    <label for="eventDescription" class="form-label">
                      <i class="bi bi-card-text"></i> M√¥ t·∫£ chi ti·∫øt <span class="text-danger">*</span>
                    </label>
                    <textarea class="form-control" id="eventDescription" rows="4"
                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán n√†y..." required></textarea>
                  </div>

                  <!-- N√∫t submit -->
                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg">
                      <i class="bi bi-send"></i> Ghi nh·∫≠n s·ª± ki·ªán
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- L·ªãch s·ª≠ s·ª± ki·ªán ƒë√£ ghi nh·∫≠n -->
            <div class="card shadow mt-4">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> S·ª± ki·ªán ƒë√£ ghi nh·∫≠n g·∫ßn ƒë√¢y</h6>
              </div>
              <div class="card-body">
                <div id="recentEvents" class="list-group">
                  <!-- Danh s√°ch s·ª± ki·ªán s·∫Ω ƒë∆∞·ª£c th√™m b·ªüi JS -->
                  <div class="text-center text-muted py-3">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mb-0 mt-2">Ch∆∞a c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Toast notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="successToast" class="toast" role="alert">
      <div class="toast-header bg-success text-white">
        <i class="bi bi-check-circle me-2"></i>
        <strong class="me-auto">Th√†nh c√¥ng</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastMessage">
        S·ª± ki·ªán ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n l√™n blockchain (m√¥ ph·ªèng)
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    // ===== API CONFIG =====
    const API_BASE_URL = 'https://web-blockchain-production.up.railway.app/api';

    // ===== INIT =====
    window.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username') || 'Guest';
      const userRole = localStorage.getItem('userRole') || 'guest';

      // X√≥a d·ªØ li·ªáu c≈© trong localStorage (migration)
      localStorage.removeItem('riceBatches');
      localStorage.removeItem('riceEvents');

      // Hi·ªÉn th·ªã th√¥ng tin user (n·∫øu c√≥)
      if (document.getElementById('userDisplay')) {
        document.getElementById('userDisplay').innerHTML = `
          <span class="badge bg-primary me-2">${userRole.toUpperCase()}</span>
          <span>${username}</span>
        `;
      }

      // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
      if (username) {
        document.getElementById('userDisplayName').textContent = username;
      }

      // Set ng√†y hi·ªán t·∫°i cho c√°c input date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('plantDate').value = today;

      const now = new Date().toISOString().slice(0, 16);
      document.getElementById('eventTime').value = now;

      // Load token IDs c√≥ s·∫µn
      loadTokenIds();

      // Load recent events
      loadRecentEvents();
    });

    // ===== LOGOUT =====
    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        window.location.href = 'login.html';
      }
    }

    // ===== UC2: T·∫†O L√î S·∫¢N PH·∫®M M·ªöI =====
    document.getElementById('createBatchForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const variety = document.getElementById('riceVariety').value;
      const location = document.getElementById('location').value;
      const area = document.getElementById('area').value;
      const plantDate = document.getElementById('plantDate').value;
      const note = document.getElementById('batchNote').value;

      // Sinh Token ID (hash m√¥ ph·ªèng)
      const tokenId = generateTokenId(variety, location, plantDate);

      try {
        console.log('=== CREATING BATCH ===');
        console.log('Token ID:', tokenId);
        console.log('Data:', { variety, location, area, plantDate });

        // G·ªçi API SIMPLE - KH√îNG C·∫¶N TOKEN
        const response = await fetch(`${API_BASE_URL}/batches/simple`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            batch_code: tokenId,
            product_name: `${variety} - ${location}`,
            quantity: parseFloat(area),
            unit: 'hecta',
            variety: variety,
            location: location,
            area: parseFloat(area),
            plant_date: plantDate,
            notes: note
          })
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response:', result);

        if (result.success) {
          // Hi·ªÉn th·ªã Token ID
          document.getElementById('generatedTokenId').textContent = tokenId;
          document.getElementById('tokenIdDisplay').style.display = 'block';

          // Hi·ªÉn th·ªã th√¥ng b√°o
          alert(`‚úÖ Th√†nh c√¥ng!\n\nM√£ l√¥: ${tokenId}\nS·∫£n ph·∫©m: ${variety}\nV·ªã tr√≠: ${location}\nDi·ªán t√≠ch: ${area} hecta`);

          // Reset form
          this.reset();

          // Reload danh s√°ch sau 1s
          setTimeout(() => {
            document.getElementById('tokenIdDisplay').style.display = 'none';
            loadTokenIds();
          }, 1000);
        } else {
          alert(`‚ùå L·ªói: ${result.message || 'Kh√¥ng th·ªÉ t·∫°o l√¥ s·∫£n ph·∫©m'}`);
        }
      } catch (error) {
        console.error('Create batch error:', error);
        alert(`‚ùå L·ªói k·∫øt n·ªëi!\n\n${error.message}\n\nVui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.`);
      }
    });    // ===== SINH TOKEN ID M√î PH·ªéNG =====
    function generateTokenId(variety, location, date) {
      const timestamp = new Date().getTime();
      const random = Math.random().toString(36).substring(2, 8).toUpperCase();
      const hash = simpleHash(variety + location + date + timestamp);
      return `BC${hash}${random}`;
    }

    // Hash ƒë∆°n gi·∫£n (m√¥ ph·ªèng)
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16).substring(0, 6).toUpperCase();
    }

    // ===== COPY TOKEN ID =====
    function copyTokenId() {
      const tokenId = document.getElementById('generatedTokenId').textContent;
      navigator.clipboard.writeText(tokenId).then(() => {
        alert('‚úÖ ƒê√£ sao ch√©p Token ID v√†o clipboard!');
      });
    }

    // ===== UC3: GHI NH·∫¨N S·ª∞ KI·ªÜN =====
    document.getElementById('eventForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const tokenId = document.getElementById('tokenId').value;
      const eventType = document.getElementById('eventType').value;
      const eventTime = document.getElementById('eventTime').value;
      const eventLocation = document.getElementById('eventLocation').value;
      const eventPerformer = document.getElementById('eventPerformer').value;
      const eventDescription = document.getElementById('eventDescription').value;

      if (!tokenId) {
        alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn m√£ l√¥!');
        return;
      }

      try {
        console.log('=== ADDING EVENT ===');
        console.log('Batch code:', tokenId);
        console.log('Event:', { eventType, eventLocation, eventDescription });

        // G·ªçi API SIMPLE - KH√îNG C·∫¶N TOKEN
        const response = await fetch(`${API_BASE_URL}/batches/${tokenId}/transaction/simple`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: eventType,
            description: eventDescription || `${eventType} - ${eventLocation}`,
            location: eventLocation
          })
        });

        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response:', result);

        if (result.success) {
          alert(`‚úÖ Th√†nh c√¥ng!\n\nM√£ l√¥: ${tokenId}\nS·ª± ki·ªán: ${eventType}\nV·ªã tr√≠: ${eventLocation}`);

          // Reset form
          this.reset();

          // Reload danh s√°ch sau 1s
          setTimeout(() => {
            loadRecentEvents();
          }, 1000);
        } else {
          alert(`‚ùå L·ªói: ${result.message || 'Kh√¥ng th·ªÉ th√™m s·ª± ki·ªán'}`);
        }
      } catch (error) {
        console.error('Add event error:', error);
        alert(`‚ùå L·ªói k·∫øt n·ªëi!\n\n${error.message}\n\nVui l√≤ng ki·ªÉm tra:\n- M√£ l√¥ c√≥ ƒë√∫ng kh√¥ng?\n- K·∫øt n·ªëi internet`);
      }
    });

    // ===== LOAD DANH S√ÅCH L√î T·ª™ API =====
    async function loadTokenIds() {
      const select = document.getElementById('tokenId');

      // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
      while (select.options.length > 1) {
        select.remove(1);
      }

      try {
        // G·ªçi API l·∫•y danh s√°ch batches
        const response = await fetch(`${API_BASE_URL}/batches`);

        if (!response.ok) {
          throw new Error('Cannot fetch batches');
        }

        const result = await response.json();
        console.log('Loaded batches:', result);

        if (result.success && result.batches && result.batches.length > 0) {
          result.batches.forEach(batch => {
            const option = document.createElement('option');
            option.value = batch.batch_code;
            option.textContent = `${batch.batch_code} - ${batch.product_name}`;
            select.appendChild(option);
          });
        } else {
          // Th√™m option m·∫´u n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu
          ['BC001ABC', 'BC002XYZ', 'BC003DEF'].forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = id + ' (M·∫´u)';
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Load batches error:', error);
        // Fallback: Th√™m option m·∫´u
        ['BC001ABC', 'BC002XYZ', 'BC003DEF'].forEach(id => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = id + ' (M·∫´u)';
          select.appendChild(option);
        });
      }
    }

    // ===== LOAD RECENT EVENTS FROM API =====
    async function loadRecentEvents() {
      const container = document.getElementById('recentEvents');

      try {
        // G·ªçi API l·∫•y t·∫•t c·∫£ batches v·ªõi transactions
        const response = await fetch(`${API_BASE_URL}/batches`);

        if (!response.ok) {
          throw new Error('Cannot fetch events');
        }

        const result = await response.json();
        console.log('Loaded events:', result);

        // L·∫•y t·∫•t c·∫£ transactions t·ª´ t·∫•t c·∫£ batches
        let allTransactions = [];

        if (result.success && result.batches && result.batches.length > 0) {
          // L·∫•y chi ti·∫øt t·ª´ng batch ƒë·ªÉ c√≥ transactions
          for (let batch of result.batches.slice(0, 5)) { // Ch·ªâ l·∫•y 5 batches g·∫ßn nh·∫•t
            try {
              const detailResponse = await fetch(`${API_BASE_URL}/batches/${batch.batch_code}`);
              const detailResult = await detailResponse.json();

              if (detailResult.success && detailResult.transactions) {
                detailResult.transactions.forEach(trans => {
                  allTransactions.push({
                    ...trans,
                    batch_code: batch.batch_code,
                    product_name: batch.product_name
                  });
                });
              }
            } catch (err) {
              console.error('Error loading batch details:', err);
            }
          }
        }

        // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t
        allTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        if (allTransactions.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="bi bi-inbox" style="font-size: 2rem;"></i>
              <p class="mb-0 mt-2">Ch∆∞a c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ghi nh·∫≠n</p>
            </div>
          `;
          return;
        }

        container.innerHTML = '';
        allTransactions.slice(0, 10).forEach(event => {
          const item = document.createElement('div');
          item.className = 'list-group-item';

          // Map action to icon
          let icon = 'üìù';
          let actionName = event.action;
          switch (event.action) {
            case 'CREATE': icon = 'üå±'; actionName = 'T·∫°o l√¥'; break;
            case 'fertilizing': icon = 'üå±'; actionName = 'B√≥n ph√¢n'; break;
            case 'irrigation': icon = 'üíß'; actionName = 'T∆∞·ªõi ti√™u'; break;
            case 'harvesting': icon = 'üåæ'; actionName = 'Thu ho·∫°ch'; break;
            case 'milling': icon = 'üè≠'; actionName = 'Xay x√°t'; break;
            case 'packaging': icon = 'üì¶'; actionName = 'ƒê√≥ng g√≥i'; break;
            case 'shipping': icon = 'üöö'; actionName = 'V·∫≠n chuy·ªÉn'; break;
            case 'warehouse_in': icon = 'üì•'; actionName = 'Nh·∫≠p kho'; break;
            case 'warehouse_out': icon = 'üì§'; actionName = 'Xu·∫•t kho'; break;
            case 'quality_check': icon = '‚úÖ'; actionName = 'Ki·ªÉm tra ch·∫•t l∆∞·ª£ng'; break;
            case 'distribution': icon = 'üè™'; actionName = 'Ph√¢n ph·ªëi'; break;
          }

          item.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${icon} ${actionName}</h6>
                <p class="mb-1 small">${event.description || ''}</p>
                <small class="text-muted">
                  <i class="bi bi-key"></i> ${event.batch_code} | 
                  <i class="bi bi-box"></i> ${event.product_name || 'N/A'} |
                  <i class="bi bi-clock"></i> ${new Date(event.timestamp).toLocaleString('vi-VN')}
                  ${event.location ? `| <i class="bi bi-geo-alt"></i> ${event.location}` : ''}
                </small>
              </div>
              <span class="badge bg-success">ƒê√£ ghi nh·∫≠n</span>
            </div>
          `;
          container.appendChild(item);
        });
      } catch (error) {
        console.error('Load events error:', error);
        container.innerHTML = `
          <div class="text-center text-muted py-3">
            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
            <p class="mb-0 mt-2">Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·ª± ki·ªán</p>
          </div>
        `;
      }
    }

    // ===== COPY SELECTED TOKEN ID =====
    function copySelectedTokenId() {
      const select = document.getElementById('tokenId');
      const tokenId = select.value;

      if (!tokenId) {
        alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn m√£ l√¥ tr∆∞·ªõc!');
        return;
      }

      navigator.clipboard.writeText(tokenId).then(() => {
        alert(`‚úÖ ƒê√£ sao ch√©p m√£ l√¥: ${tokenId}`);
      }).catch(err => {
        console.error('Copy failed:', err);
        alert('‚ùå Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng.');
      });
    }

    // ===== SHOW TOAST =====
    function showToast(message) {
      document.getElementById('toastMessage').textContent = message;
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      toast.show();
    }
  </script>

  <!-- Copyright -->
  <p style="text-align: center; margin: 20px 0; color: rgba(255, 255, 255, 0.6); font-size: 10px;">Copyright ¬© 2025 NNB
  </p>
</body>

</html>